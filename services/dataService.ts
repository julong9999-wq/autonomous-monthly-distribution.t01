import { ETFData, Category, DividendRecord } from "../types";

// ============================================================================
// PDF 數據來源 (內建靜態資料庫)
// 資料來源: 2025 ETF 預估報告 PDF (最新預估日 12/23/2025)
// ============================================================================

// 格式: Category,Code,Name,PriceStart(1/2 or IssuePrice),PriceEnd(12/23)
// 注意：若 1/2 未發行，StartPrice 使用發行價格代替 (參照 PDF 發行價格欄位)
const PDF_ETF_LIST = `
季一,0056,元大高股息,36.64,36.54
季一,00888,永豐台灣ESG,16.55,19.91
季一,00904,新光臺灣半導體30,18.39,22.28
季一,00905,FT臺灣Smart,13.80,17.04
季一,00908,富邦入息REITs+,12.40,13.76
季一,00912,中信臺灣智慧50,19.37,21.24
季一,00927,群益半導體收益,18.20,20.95
季一,00947,台新臺灣IC設計,14.60,17.76
季一,00956,中信日經高股息,9.78,11.46
季一,00960,野村全球航運龍頭,14.36,14.22
季一,00984A,主動安聯台灣高息,9.99,10.87
季二,00690,兆豐臺灣藍籌30,35.27,43.64
季二,00731,復華富時高息低波,67.60,69.25
季二,00771,元大US高息特別股,17.58,16.09
季二,00850,元大臺灣ESG永續,45.61,54.15
季二,00878,國泰永續高股息,22.16,21.61
季二,00891,中信關鍵半導體,18.24,19.36
季二,00894,中信小資高價30,21.20,26.65
季二,00932,兆豐永續高息等權,15.40,14.19
季二,00938,凱基臺灣優選30,14.28,17.28
季二,009808,華南永昌臺灣優選50,14.90,19.34
季二,00980A,主動野村臺灣優選,10.06,14.90
季二,00982A,主動群益臺灣強棒,10.01,14.02
季三,00712,復華富時不動產,9.29,9.22
季三,00713,元大台灣高息低波,53.10,50.60
季三,00728,第一金工業30,32.33,36.24
季三,00896,中信綠能及電動車,17.00,18.72
季三,00903,富邦元宇宙,15.68,17.63
季三,00915,凱基優選高股息30,24.56,23.06
季三,00918,大華優利高填息30,23.04,22.42
季三,00919,群益台灣精選高息,23.37,22.46
季三,00921,兆豐龍頭等權重,17.34,17.51
季三,00972,野村日本動能高息,14.70,18.04
季三,009802,富邦旗艦50,10.00,11.08
季三,009803,保德信市值動能50,10.04,12.61
月配,00730,富邦台灣優質高息,22.75,23.27
月配,00900,富邦特選高股息30,13.93,13.61
月配,00929,復華台灣科技優息,17.99,17.81
月配,00934,中信成長高股息,18.19,20.30
月配,00936,台新永續高息中小,15.16,15.86
月配,00939,統一台灣高息動能,14.13,14.63
月配,00940,元大臺灣價值高息,9.38,9.23
月配,00943,兆豐電子高息等權,14.62,14.29
月配,00944,野村趨勢動能高息,14.50,14.41
月配,00946,群益科技高息成長,9.25,9.59
月配,00952,凱基台灣AI50,9.92,11.67
月配,00961,FT臺灣永續高息,9.42,9.33
月配,00962,台新AI優息動能,9.77,10.60
月配,00963,中信全球高股息,9.98,11.40
月配,00964,中信亞太高股息,10.17,11.39
債券,00937B,群益ESG投等債20+,15.67,15.07
債券,00772B,中信高評級公司債,35.21,34.24
債券,00933B,國泰10Y+金融債,16.67,16.45
債劵,00773B,中信優先金融債,37.00,36.76
債劵,00720B,元大投資級公司債,35.24,33.69
債劵,00725B,國泰投資級公司債,37.45,35.72
債劵,00724B,群益投資級金融債,35.10,34.79
債劵,00679B,元大美債20年,28.35,27.27
債劵,00761B,國泰A級公司債,36.47,35.15
債劵,00795B,中信美國公債20年,28.81,27.45
債劵,00687B,國泰20年美債,29.48,28.33
債劵,00751B,元大AAA至A公司債,33.59,32.18
債劵,00792B,群益A級公司債,33.18,32.20
`;

// 格式: Code,Date(ExDiv),Amount
// 整合 PDF Page 3, 4 (季配) 與 Page 5 (月配/債券)
const PDF_DIVIDENDS = `
0056,2025/01/17,1.07
0056,2025/04/23,1.07
0056,2025/07/21,0.866
0056,2025/10/23,0.866
00888,2025/01/22,0.220
00888,2025/04/23,0.220
00888,2025/07/24,0.220
00888,2025/10/23,0.500
00904,2025/01/21,0.150
00904,2025/04/22,0.150
00904,2025/07/18,0.480
00904,2025/10/22,0.650
00905,2025/04/18,0.050
00905,2025/07/16,0.100
00905,2025/10/22,0.250
00908,2025/01/17,0.138
00908,2025/04/23,0.148
00908,2025/07/16,0.211
00908,2025/10/20,0.121
00912,2025/01/17,0.390
00912,2025/04/18,0.200
00912,2025/07/16,0.160
00912,2025/10/20,0.300
00927,2025/01/22,0.370
00927,2025/04/18,0.370
00927,2025/07/16,0.220
00927,2025/10/20,0.220
00947,2025/04/17,0.080
00947,2025/07/15,0.080
00947,2025/10/17,0.080
00956,2025/01/17,0.110
00956,2025/04/18,0.110
00956,2025/07/16,0.065
00956,2025/10/20,0.160
00960,2025/01/17,0.180
00960,2025/04/18,0.180
00960,2025/07/16,0.200
00960,2025/10/20,0.205
00984A,2025/10/20,0.210
00690,2025/02/18,0.700
00690,2025/05/19,0.310
00690,2025/08/18,0.750
00690,2025/11/18,0.890
00731,2025/02/19,0.593
00731,2025/05/20,0.593
00731,2025/08/19,0.652
00731,2025/11/19,0.652
00771,2025/02/21,0.220
00771,2025/05/22,0.220
00771,2025/08/21,0.210
00771,2025/11/21,0.210
00850,2025/02/21,0.660
00850,2025/05/22,0.600
00850,2025/08/21,0.600
00850,2025/11/21,0.700
00878,2025/02/20,0.500
00878,2025/05/19,0.470
00878,2025/08/18,0.400
00878,2025/11/18,0.400
00891,2025/02/18,0.410
00891,2025/05/19,0.410
00891,2025/08/18,0.410
00891,2025/11/18,0.600
00894,2025/02/18,0.550
00894,2025/05/19,0.400
00894,2025/08/18,0.400
00894,2025/11/18,0.400
00932,2025/02/18,0.100
00932,2025/05/19,0.100
00932,2025/08/18,0.180
00932,2025/11/18,0.200
00938,2025/08/18,0.100
00938,2025/11/18,0.180
009808,2025/11/20,0.410
00980A,2025/11/18,0.328
00982A,2025/08/18,0.236
00982A,2025/11/18,0.334
00712,2025/03/19,0.183
00712,2025/06/18,0.230
00712,2025/09/17,0.190
00712,2025/12/17,0.190
00713,2025/03/21,1.400
00713,2025/06/20,1.100
00713,2025/09/19,0.780
00713,2025/12/19,0.780
00728,2025/03/20,0.771
00728,2025/06/19,0.771
00728,2025/09/18,0.324
00728,2025/12/18,0.367
00896,2025/03/18,0.450
00896,2025/06/17,0.400
00896,2025/09/16,0.400
00896,2025/12/16,0.600
00915,2025/03/19,0.500
00915,2025/06/17,0.210
00915,2025/09/16,0.290
00915,2025/12/16,0.350
00918,2025/03/20,0.700
00918,2025/06/19,0.700
00918,2025/09/18,0.520
00918,2025/12/18,0.565
00919,2025/03/18,0.720
00919,2025/06/17,0.720
00919,2025/09/16,0.540
00919,2025/12/16,0.540
00921,2025/03/18,0.080
00921,2025/06/17,0.120
00921,2025/09/16,0.195
00921,2025/12/16,0.190
00972,2025/06/17,0.050
00972,2025/09/16,0.070
00972,2025/12/16,0.270
009802,2025/09/16,0.106
009802,2025/12/16,0.092
009803,2025/09/16,0.190
009803,2025/12/17,0.220
00730,2025/01/16,0.086
00730,2025/02/16,0.100
00730,2025/03/16,0.100
00730,2025/04/16,0.100
00730,2025/05/16,0.110
00730,2025/06/16,0.110
00730,2025/07/16,0.110
00730,2025/08/16,0.110
00730,2025/09/16,0.110
00730,2025/10/16,0.110
00730,2025/11/16,0.110
00730,2025/12/16,0.110
00900,2025/01/16,0.100
00900,2025/02/16,0.100
00900,2025/03/16,0.100
00900,2025/04/16,0.100
00900,2025/05/16,0.100
00900,2025/06/16,0.100
00900,2025/07/16,0.100
00900,2025/08/16,0.100
00900,2025/09/16,0.100
00900,2025/10/16,0.100
00900,2025/11/16,0.100
00900,2025/12/16,0.075
00929,2025/01/17,0.050
00929,2025/02/17,0.050
00929,2025/03/17,0.050
00929,2025/04/17,0.050
00929,2025/05/17,0.070
00929,2025/06/17,0.070
00929,2025/07/17,0.070
00929,2025/08/17,0.080
00929,2025/09/17,0.080
00929,2025/10/17,0.080
00929,2025/11/17,0.090
00929,2025/12/17,0.090
00934,2025/01/16,0.026
00934,2025/02/16,0.026
00934,2025/03/16,0.026
00934,2025/04/16,0.026
00934,2025/05/16,0.026
00934,2025/06/16,0.028
00934,2025/07/16,0.077
00934,2025/08/16,0.077
00934,2025/09/16,0.088
00934,2025/10/16,0.098
00934,2025/11/16,0.130
00934,2025/12/16,0.132
00936,2025/01/15,0.050
00936,2025/02/15,0.030
00936,2025/03/15,0.030
00936,2025/04/15,0.030
00936,2025/05/15,0.030
00936,2025/06/15,0.030
00936,2025/07/15,0.030
00936,2025/08/15,0.040
00936,2025/09/15,0.055
00936,2025/10/15,0.055
00936,2025/11/15,0.055
00936,2025/12/15,0.055
00939,2025/02/02,0.050
00939,2025/03/02,0.050
00939,2025/04/02,0.050
00939,2025/05/02,0.050
00939,2025/06/02,0.040
00939,2025/07/02,0.068
00939,2025/08/02,0.068
00939,2025/09/02,0.068
00939,2025/10/02,0.072
00939,2025/11/02,0.072
00939,2025/12/02,0.072
00939,2026/01/02,0.072
00940,2025/01/10,0.030
00940,2025/02/10,0.030
00940,2025/03/10,0.030
00940,2025/04/10,0.030
00940,2025/05/10,0.030
00940,2025/06/10,0.030
00940,2025/07/10,0.040
00940,2025/08/10,0.040
00940,2025/09/10,0.040
00940,2025/10/10,0.040
00940,2025/11/10,0.040
00940,2025/12/10,0.045
00940,2026/01/08,0.045
00943,2025/01/16,0.018
00943,2025/07/16,0.052
00943,2025/08/16,0.060
00943,2025/09/16,0.068
00943,2025/10/16,0.069
00943,2025/11/16,0.070
00943,2025/12/16,0.066
00944,2025/01/16,0.058
00944,2025/02/16,0.058
00944,2025/03/16,0.058
00944,2025/04/16,0.058
00944,2025/05/16,0.058
00944,2025/07/16,0.054
00944,2025/08/16,0.054
00944,2025/09/16,0.054
00944,2025/10/16,0.054
00944,2025/11/16,0.054
00944,2025/12/16,0.054
00946,2025/01/03,0.041
00946,2025/02/03,0.025
00946,2025/03/03,0.025
00946,2025/04/03,0.025
00946,2025/05/03,0.025
00946,2025/06/03,0.025
00946,2025/07/03,0.025
00946,2025/08/03,0.025
00946,2025/09/03,0.058
00946,2025/10/03,0.058
00946,2025/11/03,0.058
00946,2025/12/03,0.058
00946,2026/01/06,0.058
00952,2025/06/16,0.020
00952,2025/07/16,0.020
00952,2025/08/16,0.020
00952,2025/09/16,0.030
00952,2025/10/16,0.030
00952,2025/11/16,0.030
00952,2025/12/16,0.030
00961,2025/07/16,0.115
00961,2025/08/16,0.077
00961,2025/09/16,0.048
00961,2025/10/16,0.031
00961,2025/11/16,0.020
00961,2025/12/16,0.020
00962,2025/07/15,0.025
00962,2025/08/15,0.025
00962,2025/09/15,0.025
00962,2025/10/15,0.025
00962,2025/11/15,0.025
00962,2025/12/15,0.025
00963,2025/03/16,0.055
00963,2025/04/16,0.055
00963,2025/05/16,0.055
00963,2025/06/16,0.055
00963,2025/07/16,0.059
00963,2025/08/16,0.059
00963,2025/09/16,0.059
00963,2025/10/16,0.059
00963,2025/11/16,0.040
00963,2025/12/16,0.040
00964,2025/03/16,0.040
00964,2025/04/16,0.040
00964,2025/05/16,0.040
00964,2025/06/16,0.043
00964,2025/07/16,0.050
00964,2025/08/16,0.050
00964,2025/09/16,0.063
00964,2025/10/16,0.065
00964,2025/11/16,0.080
00964,2025/12/16,0.085
00937B,2025/01/16,0.082
00937B,2025/02/16,0.082
00937B,2025/03/16,0.080
00937B,2025/04/16,0.080
00937B,2025/05/16,0.077
00937B,2025/06/16,0.077
00937B,2025/07/16,0.072
00937B,2025/08/16,0.072
00937B,2025/09/16,0.072
00937B,2025/10/16,0.072
00937B,2025/11/16,0.072
00937B,2025/12/16,0.072
00772B,2025/01/16,0.130
00772B,2025/02/16,0.137
00772B,2025/03/16,0.142
00772B,2025/04/16,0.145
00772B,2025/05/16,0.145
00772B,2025/06/16,0.137
00772B,2025/07/16,0.130
00772B,2025/08/16,0.125
00772B,2025/09/16,0.129
00772B,2025/10/16,0.132
00772B,2025/11/16,0.132
00772B,2025/12/16,0.132
00933B,2025/01/16,0.082
00933B,2025/02/16,0.082
00933B,2025/03/16,0.082
00933B,2025/04/16,0.082
00933B,2025/05/16,0.082
00933B,2025/06/16,0.082
00933B,2025/07/16,0.072
00933B,2025/08/16,0.072
00933B,2025/09/16,0.072
00933B,2025/10/16,0.072
00933B,2025/11/16,0.072
00933B,2025/12/16,0.072
00773B,2025/01/16,0.138
00773B,2025/02/16,0.143
00773B,2025/03/16,0.150
00773B,2025/04/16,0.150
00773B,2025/05/16,0.150
00773B,2025/06/16,0.139
00773B,2025/07/16,0.134
00773B,2025/08/16,0.130
00773B,2025/09/16,0.134
00773B,2025/10/16,0.138
00773B,2025/11/16,0.138
00773B,2025/12/16,0.138
00720B,2025/01/16,0.500
00720B,2025/04/16,0.500
00720B,2025/07/16,0.450
00720B,2025/10/16,0.460
00725B,2025/01/16,0.662
00725B,2025/04/16,0.636
00725B,2025/07/16,0.566
00725B,2025/10/16,0.534
00724B,2025/01/16,0.499
00724B,2025/04/16,0.502
00724B,2025/07/16,0.438
00724B,2025/10/16,0.461
00679B,2025/02/16,0.300
00679B,2025/05/16,0.320
00679B,2025/08/16,0.280
00679B,2025/11/16,0.280
00761B,2025/02/16,0.500
00761B,2025/05/16,0.490
00761B,2025/08/16,0.430
00761B,2025/11/16,0.408
00795B,2025/02/16,0.380
00795B,2025/05/16,0.380
00795B,2025/08/16,0.360
00795B,2025/11/16,0.320
00687B,2025/03/16,0.350
00687B,2025/06/16,0.310
00687B,2025/09/16,0.300
00687B,2025/12/16,0.280
00751B,2025/03/16,0.450
00751B,2025/06/16,0.410
00751B,2025/09/16,0.410
00751B,2025/12/19,0.410
00792B,2025/03/16,0.444
00792B,2025/06/16,0.427
00792B,2025/09/16,0.425
00792B,2025/12/16,0.434
`;

// ----------------------------------------------------------------------------
// 解析邏輯
// ----------------------------------------------------------------------------

// 輔助函式：計算日期加 28 天當作預估發放日 (若無資料時)
const addDays = (dateStr: string, days: number): string => {
  const date = new Date(dateStr);
  date.setDate(date.getDate() + days);
  return date.toISOString().split('T')[0].replace(/-/g, '/');
};

const parseData = (): ETFData[] => {
  const etfLines = PDF_ETF_LIST.trim().split('\n');
  const divLines = PDF_DIVIDENDS.trim().split('\n');
  
  const divMap = new Map<string, DividendRecord[]>();

  // 1. Parse Dividends
  divLines.forEach(line => {
    const [code, date, amountStr] = line.split(',');
    if (!code) return;
    const amount = parseFloat(amountStr);
    
    if (!divMap.has(code)) {
      divMap.set(code, []);
    }
    
    // 根據 PDF 格式，配息發放日通常晚一個月左右，這裡做自動推算
    divMap.get(code)?.push({
      date: date,
      payDate: addDays(date, 28), 
      amount: amount
    });
  });

  // 2. Parse ETF Info
  const etfs: ETFData[] = [];

  etfLines.forEach(line => {
    const [catStr, code, name, startPriceStr, endPriceStr] = line.split(',');
    if (!code) return;

    let category = Category.Q1;
    if (catStr === '季一') category = Category.Q1;
    else if (catStr === '季二') category = Category.Q2;
    else if (catStr === '季三') category = Category.Q3;
    else if (catStr === '月配') category = Category.Monthly;
    else if (catStr.includes('債')) category = Category.Bond;

    let priceStart = parseFloat(startPriceStr);
    const priceRecent = parseFloat(endPriceStr);
    
    // 修正：如果 startPrice 是 NaN (CSV 中的 '-')，代表是年中發行
    // 為避免報酬率計算錯誤，通常使用發行價當作成本參考，這裡已經在 CSV 中填入發行價
    if (isNaN(priceStart)) priceStart = 0;

    // 從配息表計算總配息
    const myDivs = divMap.get(code) || [];
    const totalDiv = myDivs.reduce((sum, d) => sum + d.amount, 0);

    // 計算殖利率 (改為使用目前價格計算，符合使用者對當前股息率的預期)
    // 原公式使用起始價格 (Yield on Cost)，現改為 Recent Price
    const yieldRate = priceRecent > 0 ? Number(((totalDiv / priceRecent) * 100).toFixed(2)) : 0;
    
    // 另外計算基於成本的殖利率，用於計算含息報酬 (Total Return)
    const yieldOnCost = priceStart > 0 ? Number(((totalDiv / priceStart) * 100).toFixed(2)) : 0;
    
    // 計算報酬率 (價差) = (Recent - Start) / Start
    const returnRate = priceStart > 0 ? Number(((priceRecent - priceStart) / priceStart * 100).toFixed(2)) : 0;
    
    // 含息報酬 = 價差報酬 + 股息回報率(基於成本)
    // 這樣才能真實反映 "總資產成長" (資本利得 + 股息收入) 相對於 "初始投入" 的比例
    const returnRateWithDiv = Number((returnRate + yieldOnCost).toFixed(2));

    etfs.push({
      code,
      name,
      category,
      issuer: "", 
      type: "ETF",
      priceStart,
      priceRecent,
      yield: yieldRate,
      estYield: yieldRate, // 預估殖利率顯示也同步更新為當前殖利率
      returnRate,
      returnRateWithDiv,
      dividendHistory: myDivs
    });
  });

  return etfs;
};

// 移除所有 Promise 和 fetch，直接回傳資料
export const fetchLiveETFData = async (): Promise<ETFData[]> => {
  // 模擬非同步感覺，但實際上是靜態資料
  return new Promise((resolve) => {
      // 延遲 500ms 讓使用者感覺有在載入，體驗較好
      setTimeout(() => {
          resolve(parseData());
      }, 500);
  });
};